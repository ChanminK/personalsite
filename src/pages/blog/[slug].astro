---
import "../../styles/global.css";
import Topbar from "../../components/Topbar.astro";

export async function getStaticPaths() {
  const modules = import.meta.glob("../../content/posts/*.md", { eager: true });
  return Object.keys(modules).map((path) => {
    const slug = path.split("/").pop()?.replace(".md", "") ?? "";
    return { params: { slug } };
  });
}

const { slug } = Astro.params;

const modules = import.meta.glob("../../content/posts/*.md", { eager: true }) as Record<
  string,
  { frontmatter?: any; default: any }
>;
const entryPath = Object.keys(modules).find((p) => p.endsWith(`/${slug}.md`));
if (!entryPath) {
  throw new Error(`Post not found: ${slug}`);
}

const mod = modules[entryPath];
const Content = mod.default;
const fm = mod.frontmatter ?? {};
const title: string = fm.title ?? slug;
const dateVal = fm.date ? new Date(fm.date) : new Date();
const tags: string[] = Array.isArray(fm.tags) ? fm.tags : [];
---

<html lang="en" data-theme="dark" data-base={import.meta.env.BASE_URL}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title} · alive</title>
  </head>
  <body>
    <Topbar />

    <main class="wrap">
      <h1 style="margin-bottom:4px">{title}</h1>
      <div class="repo-meta" style="margin-bottom:12px">
        <span>{dateVal.toLocaleDateString()}</span>
        {tags.length > 0 && <span>{tags.map((t: string) => `#${t}`).join(" ")}</span>}
      </div>

      <article class="card">
        <Content />
      </article>

      <p style="margin-top:16px">
        <a class="tab" href={`${import.meta.env.BASE_URL}blog`}>← back to blog</a>
      </p>
    </main>

    <footer class="site-footer">made with astro + Need coffee</footer>
  </body>
</html>
